<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MTG Rating</title>
<style>
* {
  margin: 0;
  padding: 0;
  font-family: arial;
  color: white;
}
html {
  background-color: black;
  color: white;
  margin: 20px 20px 40px 20px;
}
#scoretable td {
  vertical-align: top;
  border: 1px solid rgb(160, 160, 160);
  padding: 5px;
}
#scoretable {
  border-spacing: 0px;
  font-size: 14px;
  border: 1px solid rgb(160, 160, 160);
}
.cardname {
  cursor: pointer;
  margin: 2px 0px;
}
.cardname.mythic {
  color: orange;
  /*color: #F2993B;*/
}
.cardname.rare {
  color: yellow;
  /*color: #E9D198;*/
}
.cardname.uncommon {
  color: rgb(0, 190, 222);
  /*color: #CAE7EF*/
  /*color: #7598A4;*/
}
.cardname.common {
  color: white;
/*  color: #D3D2D2;*/
}
.cardname img {
  position: absolute;
}
.section {
  margin-top: 30px;
}
.section div {
  margin: 8px 0;
}
.section.link-list div a {
  margin-left: 10px;
}

@media print {
  .cardname.common {
    color: black;
  }
  h1 {
    display: none;
  }
  div.section {
    display: none;
  }
  #scoretable {
    width: 100%;
    font-size: 13pt;
    border-color: black;
  }
  #scoretable td {
    border-color: black;
    color: black;
  }
}
</style>
</head>
<body>

<h1>MTG Rating: initial card evaluations for limited Magic</h1>

<!--
<div style="margin:20px 0px 0px 10px">NOTE: <a href="https://twitter.com/lsv">lsv</a> has not yet rated all the cards from Guilds of Ravnica. This page will be updated daily with new ratings a they're published to <a href="https://www.channelfireball.com/tag/set-review">channelfireball</a></div>
-->

<div class="section link-list">
  <div class="filter-links">
    <a href="index.html?filter=">Show all</a>
    <a href="index.html?filter=white">White</a>
    <a href="index.html?filter=blue">Blue</a>
    <a href="index.html?filter=black">Black</a>
    <a href="index.html?filter=red">Red</a>
    <a href="index.html?filter=green">Green</a>
    <a href="index.html?filter=white,red">Boros</a>
    <a href="index.html?filter=blue,red">Izzet</a>
    <a href="index.html?filter=black,blue">Dimir</a>
    <a href="index.html?filter=white,green">Selesnya</a>
    <a href="index.html?filter=green,black">Golgari</a>
    <a href="index.html?filter=instant">Instants</a>
    <a href="index.html?filter=removal">Removals</a>
    <a href="index.html?filter=face">Face</a>
    <a href="index.html?filter=fixing">Fixing</a>
  </div>
</div>

<table id="scoretable" style="margin-top: 30px"></table>

<div class="section link-list">
  <h2>Training mode</h2>
  <div class="filter-links">
    <a href="trainer.html?rating=channelfireball">All</a>
    <a href="trainer.html?rating=channelfireball&amp;colors=white">White</a>
    <a href="trainer.html?rating=channelfireball&amp;colors=blue">Blue</a>
    <a href="trainer.html?rating=channelfireball&amp;colors=black">Black</a>
    <a href="trainer.html?rating=channelfireball&amp;colors=red">Red</a>
    <a href="trainer.html?rating=channelfireball&amp;colors=green">Green</a>
    <a href="trainer.html?rating=channelfireball&amp;colors=gold">Gold</a>
  </div>
</div>

<div class="section link-list">
  <h2>Looking for another set?</h2>
  <div><a href="index.html?sets=rna">Ravnica Allegiance</a></div>
  <div><a href="index.html?sets=uma">Ultimate Masters</a></div>
  <div><a href="index.html?sets=grn">Guilds of Ravnica</a></div>
  <div><a href="index.html?sets=m19">Core Set 2019</a></div>
  <div><a href="index.html?sets=dom">Dominaria</a></div>
  <div><a href="index.html?sets=rix">Rivals of Ixalan</a></div>
</div>

<div class="section">
  <h2>About</h2>
  <div>- The ratings are fairly printer-friendly; just press print in your browser and it should come out ok-ish.</div>
  <div>- The ratings are not for constructed play, but limited; draft in particular.</div>
  <div>- 5's are best, 0's are worst.</div>
  <div>- Card name colors reflect the rarity of the card.</div>
  <div>- Card names ending with a star means the usefulness of the card is very contextual and therefore it appears multiple times in the list with different ratings.</div>
  <div>- Click a card name to view it. Click the name again or the card itself to close it.</div>
  <div>- The filters are very generous; everything that can possibility be included in each category is shown. If you select "Boros" for example you will see all cards Boros can possibly play. The philosopy is to rather show to much than too little.</div>
  <div>- Training links are used to practice your own card review skills. You will be shown a card. Decide how you would rate it and then click it to reveal the professional rating and a description for why it is rated that way. Click again to show the next card.</div>
  <div>- In Training mode, zoom in to a size suitable for your device. The page will stay at the same zoom level for all the cards you view.</div>
  <div>- If you spot an error (not just a rating you disagree with) feel free to get in touch at <a href="https://twitter.com/jakobmattsson">@jakobmattsson</a></div> 
</div>

<div class="section">
  <h2>Credits</h2>
  <div>Site by <a href="https://twitter.com/jakobmattsson">@jakobmattsson</a></div>
  <div>Ratings by <a href="https://twitter.com/lsv">@lsv</a> of <a href="https://www.channelfireball.com/tag/set-review">channelfireball</a></div>
</div>

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

<!--
<scr ipt src="hard coded.js"></scr ipt>
-->

<script>

  var getQueryArgs = () => {
    var pairs = location.search.slice(1).split('&').map((p) => p.split('='));
    var result = {};
    pairs.forEach((pair) => {
      result[pair[0]] = pair[1];
    });
    return result;
  };

  // this determines if we're running the site locally or remotely
  var isLocal = location.hostname === '';

  // find the currently selected set (or default to one)
  var currentSet = getQueryArgs()['sets'] || 'rna';

  // Helper
  var listify = (list) => Array.prototype.slice.call(list, 0);

  // This loads card data
  var getJsonData = (url, callback) => {
    if (isLocal) {
      callback(window.allthedata);
      return;
    }
    $.ajax({
      dataType: 'json',
      url: url
    }).done(callback);
  };

  // use this as the event handler on a card to enable toggling it on/off
  window.showCard = (function() {
    var showing = 'none';
    var currentCard = null;
    var setShow = (status) => {
      if (currentCard && currentCard.children[0])
        currentCard.children[0].style.display = status ? "block" : 'none';
      if (!status)
        currentCard = null;
      showing = status;
    };
    return (ev) => {
      if (currentCard === ev.target){
        setShow(false);
      } else {
        setShow(false);
        currentCard = ev.target;
        setShow(true);
      }
    };
  }());

  // Filters cards according to user provided settings and also adds in some additional fields
  var filterAndExtendCards = (allCards) => {

    var filter = {
      //set: currentSet, // not needed while we just load one set file at a time
      instant: location.search.indexOf("instant") !== -1,
      removal: location.search.indexOf("removal") !== -1,
      face: location.search.indexOf("face") !== -1,
      fixing: location.search.indexOf("fixing") !== -1,
      colors: [
        (location.search.indexOf('white') === -1) ? null : 'white',
        (location.search.indexOf('blue')  === -1) ? null : 'blue',
        (location.search.indexOf('black') === -1) ? null : 'black',
        (location.search.indexOf('red')   === -1) ? null : 'red',
        (location.search.indexOf('green') === -1) ? null : 'green'
      ].filter((x) => x)
    };

    allCards = allCards.filter((x) =>
      (!filter.set || filter.set == x.set) &&
      (!filter.instant || x.instant) &&
      (!filter.removal || x.removal) &&
      (!filter.face || x.face) &&
      (!filter.fixing || x.fixing) &&
      (filter.colors.length == 0 || x.color == 'artifact' || x.color == 'land' || (x.color.indexOf('+') === -1 ? filter.colors.some((c) => x.color.indexOf(c) !== -1) : x.color.split('+').every((c) => filter.colors.indexOf(c) !== -1)))
    );

    allCards.forEach((card) => {
      card.dualScore = card.lowScore != null && !isNaN(parseFloat(card.highScore));
    });

    return allCards.sort((a, b) => a.title.localeCompare(b.title));
  };

  var columnNamesForCard = (card) => {

    // This is the traditional "by color" columns
    if (location.search.indexOf("guilds") === -1) {
      var col = card.color.indexOf("-") === -1 && card.color.indexOf("+") === -1 ? card.color : 'gold';
      return [col];
    }

    var colorLookup = {
      green: ['golgari', 'selesnya'],
      red: ['boros', 'izzet'],
      blue: ['izzet', 'dimir'],
      white: ['boros', 'selesnya'],
      black: ['golgari', 'dimir']
    };

    var guildsToAddTo = {}

    if (card.color.indexOf("-") !== -1) {
      card.color.split('-').forEach((color) => {
        colorLookup[color].forEach((p) => {
          guildsToAddTo[p] = 1;
        });
      });
    } else if (card.color.indexOf("+") !== -1) {
      var parts = card.color.split("+");
      var counter = {}
      parts.forEach((p) => {
        colorLookup[p].forEach((c) => {
          counter[c] = (counter[c] || 0) + 1;
        });
      });
      Object.keys(counter).forEach((key) => {
        if (counter[key] == parts.length) {
          guildsToAddTo[key] = 1;
        }
      });
    } else if (card.color === 'artifact' || card.color === 'land') {
      guildsToAddTo[card.color] = 1
    } else {
      colorLookup[card.color].forEach((p) => {
        guildsToAddTo[p] = 1;
      });
    }

    return Object.keys(guildsToAddTo);
  };

  // Puts the given cards into a color/rating matrix
  var cardsToMatrix = (cards) => {
    var rows = {};
    var addCardWithScore = (card, score) => {
      var cols = columnNamesForCard(card);
      cols.forEach((col) => {
        rows[score] = rows[score] || {};
        rows[score][col] = rows[score][col] || [];
        rows[score][col].push(card);
      });
    };
    cards.forEach((card) => {
      var low = parseFloat(card.lowScore);
      var high = parseFloat(card.highScore);
      if (isNaN(low)) {
        console.log("Invalid score for: " + card.title);
        return;
      }
      addCardWithScore(card, low)
      if (!isNaN(high))
        addCardWithScore(card, high)
    });
    return rows;
  };

  // Gets the image url for a card, taking local/remote into account
  var getCardImageUrl = (card) => {
    if (isLocal) {
      return card.imageUrl.replace('https://raw.githubusercontent.com/jakobmattsson/mtg-cards/master', '..');
    } else {
      return card.imageUrl;
    }
  };

  // Render a matrix of cards to a given table
  var renderCardMatrix = (tableId, cardMatrix) => {

    var potentialColumns = ['white', 'blue', 'black', 'red', 'green', 'azorius', 'boros', 'dimir', 'golgari', 'gruul', 'izzet', 'orzhov', 'rakdos', 'selesnya', 'simic', 'gold', 'artifact', 'land'];
    var usedColumns = Array.prototype.concat.apply([], Object.keys(cardMatrix).map((r) => Object.keys(cardMatrix[r])));
    var columns = potentialColumns.filter((c) => usedColumns.indexOf(c) !== -1);
    var tbl = document.getElementById(tableId);

    // Add column headers
    var tr = document.createElement('tr');
    ['rating'].concat(columns).forEach((column) => {
      var td = document.createElement('td');
      td.innerHTML = column.toUpperCase();
      tr.appendChild(td);
    });
    tbl.appendChild(tr);

    // Add ratings
    Object.keys(cardMatrix).sort().reverse().forEach((rating) => {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.innerHTML = rating.toUpperCase();
      tr.appendChild(td);

      columns.forEach((column) => {
        var cards = cardMatrix[rating][column] || [];
        var td = document.createElement('td');
        td.innerHTML = cards.map((card) => {
          var text = card.title.replace(/ /g, '&nbsp;').replace(/-/g, '&#8209;') + (card.dualScore ? '*' : '');
          var imgUrl = getCardImageUrl(card);
          return '<div class="cardname ' + card.rarity + '" onclick="showCard(event)">' + text + '<img style="display:none" src="' + imgUrl + '"></div>';
        }).join('');
        tr.appendChild(td);
      });
      tbl.appendChild(tr);
    });  
  };

  // Adjust all the filters to be for the current set
  listify(document.querySelectorAll('.filter-links a')).forEach((a) => {
    a.href = a.href + "&sets=" + currentSet;
  });

  // Load the card data and kick off the page rendering
  var urlRoot = "https://raw.githubusercontent.com/jakobmattsson/mtg-cards/master/data/compiled/sets";
  var cardDataUrl = urlRoot + "/" + currentSet + ".json?cache=28";
  getJsonData(cardDataUrl, (cards) => renderCardMatrix('scoretable', cardsToMatrix(filterAndExtendCards(cards))));

  // Usage tracking
  if (!isLocal) {
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '5ba649900552da6be04dd931');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d2fuc4clr7gvcn.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  }
</script>

</body>
</html>
