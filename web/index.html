<html>
<head>

<style>

* {
  margin: 0;
  padding: 0;
  font-family: arial;
}

html {
  margin: 5px;
  background-color: black;
  color: white;
}

#scoretable td {
  vertical-align: top;
  border: 1px solid rgb(160, 160, 160);
  padding: 5px;
}

#scoretable {
  font-size: 14px;
  border: 1px solid rgb(160, 160, 160);
}

.cardname img {
  display: none;
}

.cardname {
  cursor: pointer;
}

.cardname.mythic {
  color: orange;
}
.cardname.rare {
  color: yellow;
}
.cardname.uncommon {
  color: rgb(0, 190, 255);
}
.cardname.common {
  color: white;
}

#links {
  margin: 20px 4px 0px 4px;
}

#links a {
  padding: 0px 20px;
}

a.whitelink, a.whitelink:visited {
  color: white;
}


</style>


</head>
<body>


<h1>MTG Rating: guiding your drafts</h1>

<table id="scoretable" cellspacing="0"></table>

<div id="links">
  <div style="font-weight:bold;margin:20px 0px">Filters</div>
  <div>
    <a class="whitelink" href="index.html">All</a>
    <a class="whitelink" href="index.html?filter=instant">Instants</a>
    <a class="whitelink" href="index.html?filter=removal">Removals</a>
    <a class="whitelink" href="index.html?filter=face">Face</a>
    <a class="whitelink" href="index.html?filter=fixing">Fixing</a>
  </div>

  <div>
    <a class="whitelink" href="index.html?filter=white">White</a>
    <a class="whitelink" href="index.html?filter=blue">Blue</a>
    <a class="whitelink" href="index.html?filter=black">Black</a>
    <a class="whitelink" href="index.html?filter=red">Red</a>
    <a class="whitelink" href="index.html?filter=green">Green</a>
  </div>

  <div>
    <a class="whitelink" href="index.html?filter=white,red">Boros</a>
    <a class="whitelink" href="index.html?filter=blue,red">Izzet</a>
    <a class="whitelink" href="index.html?filter=black,blue">Dimir</a>
    <a class="whitelink" href="index.html?filter=white,green">Selesnya</a>
    <a class="whitelink" href="index.html?filter=green,black">Golgari</a>
  </div>

  <div style="font-weight:bold;margin:20px 0px">Training</div>
  <div>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball">All</a>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball&amp;colors=white">White</a>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball&amp;colors=blue">Blue</a>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball&amp;colors=black">Black</a>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball&amp;colors=red">Red</a>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball&amp;colors=green">Green</a>
    <a class="whitelink" href="trainer.html?sets=grn&amp;rating=channelfireball&amp;colors=gold">Gold</a>
  </div>

</div>
<div style="margin-top:100px">
  <div><a class="whitelink" href="https://twitter.com/jakobmattsson">@jakobmattsson</a> 2018</div>
  <div>Ratings by <a class="whitelink" href="https://twitter.com/lsv">@lsv</a> of <a class="whitelink" href="https://www.channelfireball.com/tag/set-review">channelfireball</a></div>
</div>



<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>



<script>

  // this determines if we're running the site locally or remotely
  var isLocal = location.hostname == '';

  // This loads card data
  var getJsonData = function(url, callback) {
    if (isLocal) {
      callback(window.allthedata);
      return;
    }
    $.ajax({
      dataType: 'json',
      url: url
    }).done(function(data) {
      callback(data);
    });
  };

  // use this as the event handler on a card to enable toggling it on/off
  window.showCard = (function() {
    var showing = 'none';
    var currentCard = null;
    var setShow = function(status) {
      if (currentCard && currentCard.children[0])
        currentCard.children[0].style.display = status ? "block" : 'none';
      if (!status)
        currentCard = null;
      showing = status;
    }
    return () => {
      if (currentCard === window.event.target){
        setShow(false);
      } else {
        setShow(false);
        currentCard = window.event.target;
        setShow(true);
      }
    };
  }());

  // Filters cards according to user provided settings and also adds in some additional fields
  var filterAndExtendCards = function(allCards) {

    var filter = {
      set: 'm19', // not needed if we just load one set file at a time
      instant: location.search.indexOf("instant") !== -1, 
      removal: location.search.indexOf("removal") !== -1,
      face: location.search.indexOf("face") !== -1,
      fixing: location.search.indexOf("fixing") !== -1,
      colors: [
        (location.search.indexOf('white') === -1) ? null : 'white',
        (location.search.indexOf('blue')  === -1) ? null : 'blue',
        (location.search.indexOf('black') === -1) ? null : 'black',
        (location.search.indexOf('red')   === -1) ? null : 'red',
        (location.search.indexOf('green') === -1) ? null : 'green'
      ].filter((x) => x)
    };

    allCards = allCards.filter((x) =>
      (!filter.set || filter.set == x.set) &&
      (!filter.instant || x.instant) &&
      (!filter.removal || x.removal) &&
      (!filter.face || x.face) &&
      (!filter.fixing || x.fixing) &&
      (filter.colors.length == 0 || x.color == 'artifact' || x.color == 'land' || (x.color.indexOf('+') === -1 ? filter.colors.some((c) => x.color.indexOf(c) !== -1) : x.color.split('+').every((c) => filter.colors.indexOf(c) !== -1)))
    );

    allCards.forEach((card) => {
      card.dualScore = card.lowScore != null && !isNaN(parseFloat(card.highScore));
    });

    return allCards;
  };

  // Puts the given cards into a color/rating matrix
  var cardsToMatrix = (cards) => {
    var rows = {};
    var addCardWithScore = (card, score) => {
      var col = card.color.indexOf("-") === -1 && card.color.indexOf("+") === -1 ? card.color : 'gold';
      rows[score] = rows[score] || {};
      rows[score][col] = rows[score][col] || [];
      rows[score][col].push(card);
    };
    cards.forEach((card) => {
      var low = parseFloat(card.lowScore);
      var high = parseFloat(card.highScore);
      if (isNaN(low)) {
        console.log("Invalid score for: " + card.title);
        return;
      }
      addCardWithScore(card, low)
      if (!isNaN(high))
        addCardWithScore(card, high)
    });
    return rows;
  };

  // Gets the image url for a card, taking local/remote into account
  var getCardImageUrl = (card) => {
    if (isLocal) {
      return card.imageUrl.replace('https://raw.githubusercontent.com/jakobmattsson/mtg-cards/master', '..');
    } else {
      return card.imageUrl;
    }
  };

  // Render a matrix of cards to a given table
  var renderCardMatrix = function(tableId, cardMatrix) {
    var columns = ['white', 'blue', 'black', 'red', 'green', 'gold', 'artifact', 'land'];
    var tbl = document.getElementById(tableId);

    // Add column headers
    var tr = document.createElement('tr');
    ['rating'].concat(columns).forEach((column) => {
      var td = document.createElement('td');
      td.innerHTML = column.toUpperCase();
      tr.appendChild(td);
    });
    tbl.appendChild(tr);

    // Add ratings
    Object.keys(cardMatrix).sort().reverse().forEach((rating) => {
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.innerHTML = rating.toUpperCase();
      tr.appendChild(td);

      columns.forEach((column) => {
        var cards = cardMatrix[rating][column] || [];
        var td = document.createElement('td');
        td.innerHTML = cards.map((card) => {
          var text = card.title.replace(/ /g, '&nbsp;') + (card.dualScore ? '**' : '');
          var imgUrl = getCardImageUrl(card);
          return '<div class="cardname ' + card.rarity + '" onclick="showCard()">' + text + '<img src="' + imgUrl + '"></div>';
        }).join('');
        tr.appendChild(td);
      });
      tbl.appendChild(tr);
    });  
  };

  // Load the card data and kick off the page rendering
  var cardDataUrl = "https://raw.githubusercontent.com/jakobmattsson/mtg-cards/master/data/compiled/sets/m19.json?cache=5";
  getJsonData(cardDataUrl, (cards) => renderCardMatrix('scoretable', cardsToMatrix(filterAndExtendCards(cards))));

  // Usage tracking
  if (!isLocal) {
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '5ba649900552da6be04dd931');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d2fuc4clr7gvcn.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  }
</script>

</body>
</html>
